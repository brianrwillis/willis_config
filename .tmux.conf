# NOTE: requires xclip to be installed!

# Determine if we're in a vim window
# TODO: or ssh... much harder
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
        | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"

# Output: no vpn installed: blank
#         vpn on: frog
#         vpn off: X
vpn_is_connected="if [ `mullvad status 2>/dev/null ; echo $? | grep -v ^0` ] ; then echo ''; \
                  elif [ `mullvad status 2>/dev/null | cut -c -9 | grep Connected` ]; then echo 'VPN: 🐸'; \
                  else echo 'VPN: ❌'; fi"


# Disable "lock up everything with no recovery option" mode
unbind-key C-z

 # Remap to fullscreen
bind-key C-z resize-pane -Z

# Ctrl-a = prefix
set-option -g prefix C-a
unbind-key C-a
unbind-key C-u
bind-key C-a send-prefix

# set copy mode to vi
set-window-option -g mode-keys vi

# update the status bar once a second
set -g status-interval 1

# don't use escape as meta key
set -s escape-time 0

# pretty
set -g default-terminal "screen-256color"
set -g window-style 'fg=default,bg=default'
set -g window-active-style 'fg=default,bg=default'

set -g pane-border-style fg=colour238
set -g pane-active-border-style fg=colour49

setw -g monitor-activity on
set -g visual-activity on

set -g status-right-length 200
set -g status-left "#[fg=green][#S] #[fg=yellow](#P) "
set -g status-right "#($vpn_is_connected)  #[fg=colour79]#(date '+%%A %%D %%I:%%M:%%S %%p %%Z') :: #(date -u '+%%D %%H:%%M:%%S %%Z')"

set -g status-fg white
set -g status-bg grey19

set -g window-status-current-style fg=white
set -g window-status-current-style bright

# BEEG history
set-option -g history-limit 12000

############## mouse things ##############
set -g mouse on

# Fuck your mouse shit
unbind-key -T copy-mode-vi MouseDragEnd1Pane
unbind-key -T copy-mode    MouseDown1Pane
unbind-key -T copy-mode    MouseDrag1Pane
unbind-key -T copy-mode    MouseDragEnd1Pane
unbind-key -n              MouseDown1Status
unbind-key -n              M-MouseDown3Pane

# Copy and paste
bind-key -T copy-mode-vi y              send-keys -X copy-pipe "xclip -selection clipboard -i"
bind-key -T copy-mode-vi v              send-keys -X begin-selection
bind-key -T copy-mode-vi MouseDown1Pane select-pane \; send-keys -X clear-selection

# Triple click highlight
bind-key -n              TripleClick1Pane if-shell "$is_vim" \
                                                   "send-keys -M TripleClick1Pane" \
                                                   "select-pane \;\
                                                    copy-mode \;\
                                                    send-keys -X select-line"
bind-key -T copy-mode-vi TripleClick1Pane select-pane \;\
                                          send-keys -X select-line


# Double click highlight
bind-key -n              DoubleClick1Pane if-shell "$is_vim" \
                                                   "send-keys -M DoubleClick1Pane" \
                                                   "select-pane \;\
                                                    copy-mode  \;\
                                                    send-keys -X select-word"
bind-key -T copy-mode-vi DoubleClick1Pane select-pane \;\
                                          send-keys -X select-word
##########################################


# Page-up and C-U goes into buffer mode one page up if not in vim
bind-key -n PageUp if-shell "$is_vim" "send-keys PageUp" "copy-mode -eu"
bind-key -n C-u if-shell "$is_vim" "send-keys ''" "copy-mode \; send-keys ''"

# Vim-like pane switching
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R
bind C-h select-pane -L
bind C-j select-pane -D
bind C-k select-pane -U
bind C-l select-pane -R

# Resize but better
bind -n M-Left  resize-pane -L 5
bind -n M-Down  resize-pane -D 5
bind -n M-Up    resize-pane -U 5
bind -n M-Right resize-pane -R 5

# Better pane switching: \ = vertical, - = horizontal
bind "\\" split-window -h -c "#{pane_current_path}"
bind "-" split-window -v -c "#{pane_current_path}"

# Ctrl-b to go back to previous bash cmd (noted by username)
bind-key -n C-b              if-shell "$is_vim" "send-keys " \
                             "copy-mode \;\
                              send-keys -X start-of-line \;\
                              send-keys -X search-backward '^bran@.*([^:]*):*' \;\
                              send-keys '^'"
bind-key -T copy-mode-vi C-b if-shell "$is_vim" "send-keys " \
                             "send-keys -X start-of-line \;\
                              send-keys -X search-backward '^bran@.*([^:]*):*' \;\
                              send-keys '^'"

# Kill all detached tmux windows
bind-key -n F2 run-shell "tmux list-sessions | grep -v ' \(attached\)' | cut -d: -f1 | xargs -n 1 tmux kill-session -t 2>/dev/null || true" \;\
                         display-message "Old tmux sessions successfully fucked"

# Remove all swap files
bind-key -n F3 run-shell "rm -rf `find '#{pane_current_path}' -type f -name \"*.sw*\"`" \;\
                         display-message "Swap files successfully fucked"

# <prefix>+r = reload tmux.conf
bind r source-file ~/.tmux.conf \; display-message "Config reloaded ^_^"

# TODO: determind if in vim command mode on terminal first...
# Ctrl-w to git status
bind-key -n C-w if-shell "$is_vim" "send-keys ''" "send-keys 'git status'"
# Ctrl-o to make a commit message
bind-key -n C-o if-shell "$is_vim" "send-keys ''" "send-keys 'git commit -m \"\"' OD"
# Ctrl-l to make an add -u commit message
bind-key -n C-l if-shell "$is_vim" "send-keys ''" "send-keys 'git commit -am \"\"' OD"
# Ctrl-f to git diff
bind-key -n C-f if-shell "$is_vim" "send-keys ''" "send-keys 'git diff '"
# Ctrl-k to git checkout
bind-key -n C-k if-shell "$is_vim" "send-keys ''" "send-keys 'git checkout '"

# Ctrl-j = ESC
bind-key -n C-j if-shell "$is_vim" "send-keys C-j" "send-keys "


# Resurrection
set -g @resurrect-strategy-vim 'session'
run-shell ~/repos/willis_config/tmux-resurrect/resurrect.tmux
